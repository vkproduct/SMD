<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор ценовых акций</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .container { max-width: 1200px; }
        .header { margin-bottom: 30px; }
        .table-container { overflow-x: auto; }
        .competitor-gap-positive { color: red; }
        .competitor-gap-negative { color: green; }
        .full-data { display: none; }
        .recommendations-section { margin-top: 20px; }
        .history-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-tooltip {
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }
        .table td:nth-child(7) { /* History колонка */
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
        }
        .table th {
            white-space: nowrap;
        }
        .table td {
            vertical-align: middle;
        }
        .competitor-gap-positive {
            color: #dc3545;
            font-weight: 500;
        }
        .competitor-gap-negative {
            color: #198754;
            font-weight: 500;
        }
        .table-container {
            margin-top: 1rem;
            overflow-x: auto;
        }
        .recommendations-section {
            margin-top: 2rem;
        }
        .accordion-body {
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Генератор ценовых акций</h1>
            <p class="text-muted">Загрузите файл с данными для анализа и получения рекомендаций</p>
        </div>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
        {% endif %}

        {% if success %}
        <div class="alert alert-success" role="alert">
            Файл успешно обработан! Последнее обновление: {{ last_update }}
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Выберите файл (CSV или Excel)</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv,.xlsx,.xls" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Загрузить и проанализировать</button>
                </form>
            </div>
        </div>

        {% if data_store.processed_data is not none %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Результаты анализа</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <a href="/api/export?format=csv" class="btn btn-outline-secondary btn-sm">Скачать CSV</a>
                    <a href="/api/export?format=excel" class="btn btn-outline-secondary btn-sm">Скачать Excel</a>
                    <button class="btn btn-outline-secondary btn-sm" id="showFullData">Показать все метрики</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleRecommendations()">Показать рекомендации</button>
                </div>
                <div class="table-container" id="simpleTable">
                    {{ table|safe }}
                </div>
                <div class="table-container d-none" id="fullTable"></div>
                <div class="recommendations-section" id="recommendationsSection" style="display: none;">
                    <h6>Подробные рекомендации</h6>
                    <div class="accordion" id="recommendationsAccordion"></div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Инициализация tooltips при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    template: '<div class="tooltip history-tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
                })
            })
        });

        document.getElementById('showFullData').addEventListener('click', () => {
            fetch('/api/full_data')
                .then(response => response.json())
                .then(data => {
                    const table = document.createElement('table');
                    table.className = 'table table-striped';
                    const thead = table.createTHead();
                    const tbody = table.createTBody();
                    const headers = Object.keys(data[0]);
                    const headerRow = thead.insertRow();
                    
                    // Добавляем заголовки
                    headers.forEach(h => {
                        const th = document.createElement('th');
                        th.textContent = h;
                        headerRow.appendChild(th);
                    });
                    
                    // Добавляем данные
                    data.forEach(row => {
                        const tr = tbody.insertRow();
                        headers.forEach(h => {
                            const td = tr.insertCell();
                            
                            // Форматируем значение в зависимости от типа данных
                            if (h === 'History') {
                                td.setAttribute('data-bs-toggle', 'tooltip');
                                td.setAttribute('data-bs-placement', 'top');
                                td.setAttribute('title', row[h]);
                                td.classList.add('history-tooltip');
                                td.textContent = row[h].substring(0, 50) + '...';
                            } else if (h === 'Competitor_Gap') {
                                td.textContent = row[h] + '%';
                                td.className = row[h] > 0 ? 'competitor-gap-positive' : 'competitor-gap-negative';
                            } else if (typeof row[h] === 'number') {
                                td.textContent = row[h].toLocaleString('ru-RU', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                            } else {
                                td.textContent = row[h];
                            }
                        });
                    });
                    
                    // Обновляем DOM
                    document.getElementById('fullTable').innerHTML = '';
                    document.getElementById('fullTable').appendChild(table);
                    document.getElementById('fullTable').classList.remove('d-none');
                    document.getElementById('simpleTable').classList.add('d-none');
                    
                    // Переинициализация tooltips
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl, {
                            template: '<div class="tooltip history-tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
                        })
                    });
                })
                .catch(error => console.error('Ошибка:', error));
        });

        function toggleRecommendations() {
            const section = document.getElementById('recommendationsSection');
            const accordion = document.getElementById('recommendationsAccordion');
            const button = event.target;
            
            if (section.style.display === 'none') {
                const table = document.querySelector('#simpleTable table');
                const rows = table.querySelectorAll('tbody tr');
                accordion.innerHTML = '';
                
                rows.forEach((row, index) => {
                    const product = row.cells[0].textContent;
                    const recommendation = row.cells[7].textContent;
                    
                    const item = document.createElement('div');
                    item.className = 'accordion-item';
                    item.innerHTML = `
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                ${product}
                            </button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#recommendationsAccordion">
                            <div class="accordion-body">
                                ${recommendation.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                    accordion.appendChild(item);
                });
                
                section.style.display = 'block';
                button.textContent = 'Скрыть рекомендации';
            } else {
                section.style.display = 'none';
                button.textContent = 'Показать рекомендации';
            }
        }
    </script>
</body>
</html> 